srcdir=@srcdir@
export prefix=@prefix@
export exec_prefix=@exec_prefix@
export includedir=@includedir@
export datadir=@datarootdir@/b2l
export dataluadir=${datadir}/lua
export datalibluadir=${datadir}/lib/lua
export bindir=@bindir@
VPATH=$(srcdir)

CFLAGS:= -g -O0 -Wall -Wno-unused-function -fPIC -shared
CFLAGS+= -I@builddir@ -I$(srcdir) -I${srcdir}/../lua-5.2.3/src
CFLAGS+= @GLIB2_CFLAGS@ @GDKPIXBUF2_CFLAGS@ @CFLAGS@

LDFLAGS:= -lglwin -lglb-glcore -lGL
LDFLAGS+= @GLIB2_LIBS@ @GDKPIXBUF2_LIBS@ @LDFLAGS@

FLEX = @FLEX@
BISON = @BISON@

INSTALL?=install
INSTALL_PROGRAM?=$(INSTALL)
INSTALL_DATA?=$(INSTALL) -m 644

all: b2l_material_editor.so

lex.glsl.c lex.glsl.h: glsl.lex
	$(FLEX) --header-file=lex.glsl.h -P glsl -o $@ $<

lex.meta.c lex.meta.h: glsl_meta_filter.lex
	$(FLEX) --header-file=lex.meta.h -P meta -o $@ $<

glsl.tab.c glsl.tab.h: glsl.y
	$(BISON) $<

GENERATED=lex.glsl.c lex.glsl.h lex.meta.c lex.meta.h glsl.tab.c glsl.tab.h

b2l_material_editor.so: b2l_material_editor.c $(GENERATED) glsl_common.h
	$(CC) $(CFLAGS) glsl.tab.c lex.meta.c lex.glsl.c $< $(LDFLAGS) -o $@

clean:
	@-rm b2l_material_editor.so $(GENERATED)

install: b2l_material_editor.so $(srcdir)/b2l_material_editor.lua
	$(INSTALL) -d $(DESTDIR)$(dataluadir)
	$(INSTALL) -d $(DESTDIR)$(datalibluadir)
	$(INSTALL_PROGRAM) b2l_material_editor.so $(DESTDIR)$(datalibluadir)
	$(INSTALL_DATA) $(srcdir)/b2l_material_editor.lua $(DESTDIR)$(datadir)
	$(INSTALL_DATA) $(srcdir)/pprint.lua $(DESTDIR)$(dataluadir)
